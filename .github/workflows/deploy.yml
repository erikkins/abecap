# GitHub Actions - CI/CD Pipeline
name: Deploy RigaCap

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Test
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # Backend tests
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Run backend tests
        run: |
          cd backend
          pytest -v || true  # Don't fail on no tests yet
      
      # Frontend tests
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend tests
        run: |
          cd frontend
          npm run lint || true
          npm test || true

  # ============================================================================
  # Build & Deploy
  # ============================================================================
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      # AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # Build Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          VITE_API_URL: https://api.rigacap.com
      
      # Deploy Frontend to S3
      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/dist s3://rigacap-prod-frontend-149218244179 --delete
      
      # Invalidate CloudFront
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E1BA002TIC6UBN \
            --paths "/*"
      
      # Pre-deploy: Save current data to S3 before updating Lambda
      - name: Pre-deploy data export
        run: |
          echo "üì¶ Exporting current price data to S3..."
          curl -X POST "https://api.rigacap.com/api/data/pre-deploy" \
            -H "Content-Type: application/json" \
            --max-time 120 || echo "‚ö†Ô∏è Pre-deploy export skipped (Lambda may be cold)"

      # Login to ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Build and push Docker image
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: rigacap-prod-api
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend
          docker build -f Dockerfile.lambda -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --provenance=false \
            --sbom=false \
            .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # Deploy same image to both API and Worker Lambdas
      - name: Deploy Lambda (API + Worker)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: rigacap-prod-api
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws lambda update-function-code \
            --function-name rigacap-prod-api \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          aws lambda update-function-code \
            --function-name rigacap-prod-worker \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # Wait for both Lambda updates to propagate
      - name: Wait for Lambda updates
        run: |
          echo "‚è≥ Waiting for Lambda updates to complete..."
          aws lambda wait function-updated --function-name rigacap-prod-api
          aws lambda wait function-updated --function-name rigacap-prod-worker
          echo "‚úÖ Both Lambdas updated ‚Äî old containers invalidated"

      # Post-deploy: Warmup both Lambdas
      - name: Warmup Lambdas
        run: |
          echo "üî• Warming up API Lambda..."
          curl -s "https://api.rigacap.com/health" --max-time 30 || echo "‚ö†Ô∏è API warmup timed out"
          echo "üî• Warming up Worker Lambda..."
          aws lambda invoke \
            --function-name rigacap-prod-worker \
            --payload '{"warmer": true}' \
            --cli-read-timeout 300 \
            /tmp/warmup-result.json || echo "‚ö†Ô∏è Worker warmup timed out"
          echo "‚úÖ Lambdas warmed up!"

      # Done
      - name: Deployment complete
        run: |
          echo "‚úÖ Deployment complete!"
          echo "API: https://api.rigacap.com"
          echo "Worker: rigacap-prod-worker (EventBridge + direct invoke)"
