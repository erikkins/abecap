# GitHub Actions - CI/CD Pipeline
name: Deploy Stocker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Test
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # Backend tests
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Run backend tests
        run: |
          cd backend
          pytest -v || true  # Don't fail on no tests yet
      
      # Frontend tests
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend tests
        run: |
          cd frontend
          npm run lint || true
          npm test || true

  # ============================================================================
  # Build & Deploy
  # ============================================================================
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      # AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # Build Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
      
      # Deploy Frontend to S3
      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/dist s3://stocker-prod-frontend --delete
      
      # Invalidate CloudFront
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
      
      # Build Backend
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Package Lambda
        run: |
          cd backend
          pip install -r requirements.txt -t package/
          cp -r *.py package/
          cd package
          zip -r ../lambda.zip .
      
      # Deploy Lambda
      - name: Deploy Lambda
        run: |
          aws lambda update-function-code \
            --function-name stocker-prod-api \
            --zip-file fileb://backend/lambda.zip
      
      # Done
      - name: Deployment complete
        run: |
          echo "âœ… Deployment complete!"
          echo "Frontend: https://d1234567890.cloudfront.net"
          echo "API: https://api123456.execute-api.us-east-1.amazonaws.com"
